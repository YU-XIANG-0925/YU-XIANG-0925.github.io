<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>ROBOT</title>
    <link rel="stylesheet" href="/static/css/bootstrap.min.css" />
    <script src="../js/plugins/cryptojs/aes.js"></script>
    <script src="../js/plugins/cryptojs/mode-ecb-min.js"></script>
    <script src="../js/plugins/cryptojs/md5-min.js"></script>
    <script src="detector.js"></script>
    <script src="../lib/three.min.js"></script>
    <script src="../lib/STLLoader.js"></script>
    <script src="three.js"></script>
    <script src="xrobot.js"></script>
    <script src="motion.js"></script>
    <script src="/static/js/plugins/jQuery/jQuery-2.2.0.min.js"></script>
    <script src="/static/js/plugins/bootstrap/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/10.2.0/bootstrap-slider.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/10.2.0/css/bootstrap-slider.css"
    />
    <style>
      .box.box-solid.box-info {
        border-bottom: 1px solid #00c0ef;
      }
      .vertical-10px {
        padding-top: 10px;
      }
      .logo {
        width: 15em;
        padding: 10px;
      }
      .input-group {
        padding-bottom: 1em;
        height: 2em;
      }
      .input-group button {
        border-top-left-radius: 3px;
        border-bottom-left-radius: 3px;
      }
      .red {
        color: red;
      }
      #ex1Slider .slider-selection {
        background: #bababa;
      }
    </style>

    <script>
      const API_TYPE = "motion";
      const API_TOKEN =
        "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJodHRwczovL2FwaS5udXdhcm9ib3RpY3MuY29tIiwic3ViIjoiYXV0aC5udXdhcm9ib3RpY3N8MTgyMDc3MDI3NTM0IiwiYXVkIjoiMzEyNzAxNDYtNzE3Qi00RUYwLTg2NDctRjNBQkQ3M0E4NjMwIiwiaWF0IjoxNzU5NDYxNzkzLCJleHAiOjM1MTg5MjQxODYsImp0aSI6IjM3YTI2Yjg5LThhYjctNDhlZi04YTczLTMyMDlkMWU1MDM0OCIsImNvbnRleHQiOnsidHlwZSI6ImFjY2VzcyIsInByb3ZpZGVyIjoiZGV2ZWxvcGVyfG8yMDM5Mm9AZ21haWwuY29tIn0sInNjb3BlIjoicHJvZmlsZSBhdXRoIGF1dGhfcmVmcmVzaC5nZXQgb3RhIG90YS5nZXQgZGV2ZWxvcGVyIn0.ILbJYRCwhiR_EhzUTtGWrBPUc9SK8_vTARlcYP0aqIjDVIVw5-1ZliuPxFWVtl96Z7uD32RutGFhbvvd9crou_MIu10Cd708phQlLU6FlAB99111hnJjBnPzGcIU-9s7AJyYd4F388ZmvtqdVNy-PJuv1Eeoec-NRx9hVDW0JuCuQ4EsHXPdv2czpmf41eaZCPZdu312O1V6Fyage27sj_HMsWkSnQ8yy_vYc3c-4AaMPr-3xkl74_GCL7MuMOAfzmQvTlZmmWisShHaISTGgWhbHYqAkPyQDMAYLDAUA7XgvrZAPUnjWhK4Vb5GD1r1mOZhKWPnjuduCcNAbr_UIg";
      
      window.onload = function () {
          //var select2 = document.getElementById('select2').value;
          //motion_load(xrobot_nuwa + '/assets/motion/' + select2 + '.xml');
          try {
            if (Detector.webgl) {
              if (getQueryStringValue("name")) {
                motion_change(getQueryStringValue("name"));
              } else {
                motion_change();
              }
              xrobot_init();

              texture_init();
              three_init();

              video_display(false);
              document.getElementById("nowPlaying").className = "";
            } else {
              var warning = Detector.getWebGLErrorMessage();
              document.getElementById("robotContainer").appendChild(warning);
            }

            // Without JQuery
            var slider = new Slider("#ex1", {
              formatter: function (value) {
                return "Current value: " + value;
              },
            });
            slider.on("slideStop", function (value) {
              var name = document.getElementById("select1").value;
              input_rotate2(name, value);
            });
          } catch (error) {
            if (
              error.message === "Cannot read property 'getExtension' of null"
            ) {
              document.getElementById("nowPlaying").innerHTML =
                "Error creating WebGL context.";
            } else {
              document.getElementById("nowPlaying").innerHTML =
                "Error: " + error;
            }
            document.getElementById("nowPlaying").className = "red";
          }
        };
      var scheme = "http";
      var env = window.location.hostname.split(".")[0];
      var port = env === "localhost" ? "6700" : "80";
      env = env === "localhost" ? env : window.location.hostname;
      if (
        window.location.hostname === "dss.nuwarobotics.cn" ||
        window.location.hostname === "dss.nuwarobotics.com"
      ) {
        env = env.replace("dss", "api");
        port = "443";
        scheme = "https";
      } else {
        env = env.replace("dss", "api");
      }
      // var basicToken = "";
      var video1;
      var videocanvas;
      var videocanvasctx;
      var videotexture;
      var videomaterial;
      var video_width = 640;
      var video_height = 480;
      function texture_init() {
        video_width = 640;
        video_height = 640;
        video_width = 512;
        video_height = 512;
        video1 = document.getElementById("video1");
        videocanvas = document.createElement("canvas");
        videocanvasctx = videocanvas.getContext("2d");
        videocanvas.width = video_width; //640;
        videocanvas.height = video_height; //480;
        videocanvasctx.fillStyle = "#000000";
        videocanvasctx.fillRect(0, 0, video_width, video_height); //640,480);
        videotexture = new THREE.Texture(videocanvas);
        videomaterial = new THREE.MeshBasicMaterial({
          map: videotexture,
          overdraw: 0.5,
        });
      }
      function texture_update() {
        if (video1.readyState === video1.HAVE_ENOUGH_DATA) {
          //draw video to canvas starting from upper left corner
          draw_image_rotate(); //videocanvasctx.drawImage(video1, 0, 0);
          //tell texture object it needs to be updated
          videotexture.needsUpdate = true;
        }
      }
      function draw_image_rotate() {
        var angle = -Math.PI / 2;
        var x = videocanvas.width / 2;
        var y = videocanvas.height / 2;
        var width = video_width; //640;
        var height = video_height; //480;
        videocanvasctx.translate(x, y);
        videocanvasctx.rotate(angle);
        videocanvasctx.drawImage(
          video1,
          -width / 2,
          -height / 2,
          width,
          height
        );
        videocanvasctx.rotate(-angle);
        videocanvasctx.translate(-x, -y);
      }
      //
      function rotate() {
        var name = document.getElementById("select1").value;
        input_rotate(name);
      }
      function video_load(url) {
        var e = document.getElementById("video1");
        // url =
        //   scheme + "://" + env + ":" + port + "/v1/developer/download" + url;
        // if (basicToken) {
        //   url += "?token=" + basicToken;
        // }
        console, log("嘗試載入本地影片: ", url);
        e.src = url;
        e.crossOrigin = "";
      }
      function video_start(url) {
        var e = document.getElementById("video1");
        //e.controls = true;
        e.play();
      }
      function video_stop() {
        var e = document.getElementById("video1");
        e.controls = false;
        e.pause();
      }
      function video_display(enable) {
        //console.log('video_display', enable);
        video1.style.display = enable ? "block" : "none";
      }
      function video_show() {
        var enable = video1.style.display == "none";
        video_display(enable);
      }
      function motion_change(value) {
        var select2 =
          value || document.getElementById("select2").value + ".xml";
        motion_stop();

        // JSON 檔案儲存在相對於 robot.html 的 ./motions/ 資料夾下的 xml檔案中
        var localXmlPath = "./motions/" + select2;

        console.log("準備載入本地動作檔:", localXmlPath); // 方便除錯

        document.getElementById("nowPlaying").innerHTML =
          "Play (local): " + select2;

        // 呼叫 motion_load，傳入本地檔案的路徑
        motion_load(localXmlPath);
      }

      function getQueryStringValue(key) {
        return decodeURIComponent(
          window.location.search.replace(
            new RegExp(
              "^(?:.*[&\\?]" +
                encodeURIComponent(key).replace(/[\.\+\*]/g, "\\$&") +
                "(?:\\=([^&]*))?)?.*$",
              "i"
            ),
            "$1"
          )
        );
      }
    </script>
  </head>

  <body id="robotContainer">
    <div class="row vertical-10px">
      <div class="col-md-12">
        <div class="box box-solid box-info">
          <div class="box-body"></div>

          <div>
            <div class="box-header"></div>
            <div class="box-body">
              <div class="row">
                <img src="/static/img/logo.png" class="center-block logo" />
                <div class="text-center col-md-6 col-sm-offset-3">
                  <div class="row">
                    <div class="col-md-2">
                      <div class="input-group">
                        <select name="select1" id="select1">
                          <option value="footprint">footprint</option>
                        </select>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="input-group">
                        <button onclick="rotate()">rotate</button>
                        <input
                          id="ex1"
                          data-slider-id="ex1Slider"
                          type="text"
                          data-slider-min="0"
                          data-slider-max="30"
                          data-slider-step="1"
                          data-slider-value="0"
                        />
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="input-group">
                        <button onclick="video_show()">show video</button>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="input-group">
                        <button onclick="motion_start_stop()">
                          start / stop
                        </button>
                      </div>
                    </div>
                  </div>

                  <div class="input-group">
                    <select
                      name="select2"
                      id="select2"
                      onchange="motion_change()"
                      hidden="true"
                    >
                      <option value="666_SP_Karate">666_SP_Karate</option>
                    </select>
                    <div>
                      <span id="nowPlaying"></span>
                      <span id="fps"></span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <video id="video1" width="256" height="144"></video>
  </body>
</html>
